<html>
<head>
	<title>Unit Tests: api.js</title>

	<script src="../jquery/jquery-1.2.6.js" type="text/javascript"></script>
	<link href="http://dev.jquery.com/view/trunk/qunit/testsuite.css" rel="stylesheet" type="text/css" media="screen">
	<script src="http://dev.jquery.com/view/trunk/qunit/testrunner.js" type="text/javascript"></script>

	<script src="../api.js" type="text/javascript"></script>

<script type="text/javascript">
(function($){

$(function(){

module('API');

test('no jquery', function(){
	var test = new API({
		name: 'test',
		element_api: {
			foo: function( t_elem, cn ){
				$(t_elem).addClass(cn);
			},
			bar: function( t_elem, cn ){
				$(t_elem).removeClass(cn);
			}
		}
	});

	var $dog = $('#dog'), dog = $dog[0];
	test(dog);
	ok(dog.test && dog.test.foo, 'construct through api object');
	dog.test.foo('chicken');
	ok($dog.hasClass('chicken'), 'apply through elem');
	ok( !$dog.test && !$dog.test__foo, 'api not available on jQuery');
});


test('no ctors, expando denied', function(){
	var test0 = new API({
		name: 'test0',
		element_api: {
			foo: function( t_elem, cn ){
				$(t_elem).addClass(cn);
			},
			bar: function( t_elem, cn ){
				$(t_elem).removeClass(cn);
			}
		},
		element_constructor: false,
		extend_jquery_wrapper: true
	});

	test0.foo($('#dog')[0], 'green');
	ok($('#dog').hasClass('green'), 'call through api object');

	var $list = $('#dog, #fish, #cat').test0__foo('blue');
	ok($list.filter('.blue').length==3, 'call through jQuery selection');
	ok(! $list.test0__bar('blue').filter('.blue').length, 'jQuery return when called through jQuery selection');
});

test('no ctors, expando allowed', function(){
	var test1 = new API({
		name: 'test1',
		element_api: {
			foo: function( t_elem, cn ){
				var defaultColor = t_elem.test1 && t_elem.test1.defaults && t_elem.test1.defaults.colorClass;
				cn = cn || defaultColor || 'wrong';
				$(t_elem).addClass(cn);
			},
			bar: function( t_elem, cn ){
				$(t_elem).removeClass(cn);
			}
		},
		api: {
			defaults: {
				colorClass: 'orange'
			}
		},
		extend_jquery_wrapper: true
	});

	var $dog = $('#dog'), dog = $dog[0];
	test1(dog);
	ok(dog.test1, 'constructor form extends element');
	ok(dog.test1.foo, '...and adds proxies to the extension');
	dog.test1.foo('test1');
	ok($dog.hasClass('test1'), '...that work!');

	var $cat = $('#cat'), cat = $cat[0];
	$cat.test1();
	ok(cat.test1, 'construction through jQuery selection extends element');
	ok(cat.test1.foo, '...and adds proxies to the extension');
	cat.test1.foo('test1');
	ok($cat.hasClass('test1'), '...that work!');

	var $all = $('#main > div').test1__foo('apples');
	ok($all.filter('.apples').length==4, 'applying through jQuery affects _all_ elements');
});

test('no ctors, expando allowed, use options', function(){
	var test2 = new API({
		name: 'test2',
		element_api: {
			foo: function( t_elem, cn ){
				var defaultColor = t_elem.test2 &&
							t_elem.test2.defaults &&
							t_elem.test2.defaults.colorClass ||
							test2.defaults.colorClass;

				cn = cn || defaultColor || 'wrong';
				$(t_elem).addClass(cn);
			},
			bar: function( t_elem, cn ){
				$(t_elem).removeClass(cn);
			}
		},
		api: {
			defaults: {
				colorClass: 'test2'
			}
		},
		extend_jquery_wrapper: true
	});

	var $dog = $('#dog'), dog = $dog[0];
	test2(dog);
	ok(! dog.test2.defaults, 'constructor form extends element, but not with defaults');
	dog.test2.foo();
	ok($dog.hasClass('test2'), 'but methods see api.defaults');

	var $fish = $('#fish'), fish = $fish[0];
	test2(fish, { defaults: { colorClass: 'orange'} });
	ok(fish.test2.defaults, 'constructor extends element with options');
	fish.test2.foo();
	ok($fish.hasClass('orange'), 'and methods see instance.defaults');

	var $list = $('#cat, #car'), cat=$list[0], car=$list[1];
	$list.test2({ defaults: {colorClass: 'purple'} });
	ok(cat.test2.defaults && car.test2.defaults, 'construction through jQuery selection extends all elements with options');
	ok(cat.test2.defaults !== car.test2.defaults, '...cloned so they are not ===');

	test2.defaults.colorClass = 'banjo';
	var $all = $('#main > div').test2__foo();

	ok($dog.is('.banjo'), 'applying through jQuery gets options right per elem (no default)');
	ok($fish.is('.orange:not(.test2)'), 'applying through jQuery gets options right per elem (individually set)');
	ok($(cat).is('.purple'), 'applying through jQuery gets options right per elem (jQuery set)');
	ok($(car).is('.purple'), 'applying through jQuery gets options right per elem (jQuery set)');
});

test('with ctors (expando required), with options', function(){
	var test3 = new API({
		name: 'test3',
		element_api: {
			foo: function( t_elem, cn ){
				var defaultColor = t_elem.test3 &&
							t_elem.test3.defaults &&
							t_elem.test3.defaults.colorClass ||
							test3.defaults.colorClass;

				cn = cn || defaultColor || 'wrong';
				$(t_elem).addClass(cn);
			},
			bar: function( t_elem, cn ){
				$(t_elem).removeClass(cn);
			}
		},
		api: {
			defaults: {
				colorClass: 'test3'
			}
		},
		element_constructor: function(elem, x, y, z){
			var options = {};
			if ( x !== undefined ) {
				elem.test3.x = x;
			}
			if ( y !== undefined ) {
				options.y = y;
			}
			if ( z !== undefined ) {
				options.z = z;
			}
			return options;
		},
		extend_jquery_wrapper: true
	});

	var $list = $('#fish, #dog, #cat, #car');
	var $mammals = $list.filter('#dog, #cat');
	var $cat = $('#cat'), cat = $cat[0], $dog = $('#dog'), dog = $dog[0];
	$mammals.test3('fur', 'live birth', 'breath air');
	equals(dog.test3.x, 'fur', 'constructor called, installs properties');

	$list.test3__foo('blue');
	ok($dog.hasClass('blue'), 'jQuery call hits elements with the expando');
	ok(!$('#fish').hasClass('blue'), '...and misses those without');
});

test('globals, deny jQuery wrapper', function(){
	window.Test4 = new API({
		name: 'test4',
		element_api: {
			foo: function( t_elem, cn ){
				$(t_elem).addClass(cn);
			},
			bar: function( t_elem, cn ){
				$(t_elem).removeClass(cn);
			}
		},
		extend_jquery: 'Test4'
	});

	var $dog = $('#dog'), dog = $dog[0];
	$.Test4(dog);
	ok(dog.test4 && dog.test4.foo, 'construct through jQuery global');
	dog.test4.foo('chicken');
	ok($dog.hasClass('chicken'), 'apply through elem');
	ok( !$dog.test4 && !$dog.test4__foo, 'api not available on jQuery');

	var $fish = $('#fish'), fish = $fish[0];
	Test4(fish);
	ok(fish.test4 && fish.test4.foo, 'construct through window global');
	fish.test4.foo('chicken');
	ok($fish.hasClass('chicken'), 'apply through elem');
	ok( !$fish.test4 && !$fish.test4__foo, 'api not available on jQuery');

});

test("handling of 'this'", function(){

	var test5 = new API({
		name: 'test5',
		element_api: {
			this_should_be_elem: function( elem ){
				ok(this===elem, 'this === elem, for element based calls');
			},
			this_should_be_global: function( elem ){
				ok(this===test5, 'this === global, for global based calls');
			}
		},
		extend_jquery_wrapper: true,
		extend_jquery: true
	});

	var $dog = $('#dog'), dog = $dog[0];
	test5.this_should_be_global(dog);
	$dog.test5__this_should_be_elem();
	$.test5.this_should_be_global(dog);
	test5(dog);
	dog.test5.this_should_be_elem();

});

test('regressions', function(){
});





});

})(jQuery);
</script>

</head>
<body>
	<h1>Unit Tests: api.js</h1>
	<h2 id="banner"></h2>
	<h2 id="userAgent"></h2>
	<ol id="tests"></ol>
	<div id="main">
		<div id='fish' class='fish'></div>
		<div id='dog' class='dog'></div>
		<div id='cat' class='cat'></div>
		<div id='car'></div>
	</div>
</body>
</html>
